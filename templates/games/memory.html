{% extends "base.html" %}
{% block title %}Memory Training{% endblock %}
{% block content %}
<div class="max-w-2xl mx-auto">
    <!-- Back Button -->
    <a href="/" class="inline-block mb-6 text-primary hover:text-primary-light font-semibold transition-colors">‚Üê Back to Home</a>

    <!-- Game Container -->
    <div class="glass-card animate-in">
        <div class="flex justify-between items-start mb-8">
            <div>
                <h1 class="text-4xl font-bold mb-2">üß© Memory Training</h1>
                <p class="text-text-secondary">Watch the pattern and click the squares in order</p>
            </div>
            <div class="text-right">
                <p class="text-sm text-text-muted mb-1">Best Score</p>
                <p class="text-3xl font-bold text-primary">{{ best_score }}</p>
                {% if total_games > 0 %}
                <p class="text-xs text-text-muted mt-1">Games: {{ total_games }}</p>
                {% endif %}
            </div>
        </div>

        <!-- Stats Row -->
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 2rem; padding-bottom: 2rem; border-bottom: 1px solid var(--glass-border);">
            <div style="text-align: center;">
                <p style="font-size: 0.875rem; color: var(--text-muted); margin-bottom: 0.5rem;">Level</p>
                <p style="font-size: 1.875rem; font-weight: bold; color: var(--primary);" id="level">1</p>
            </div>
            <div style="text-align: center;">
                <p style="font-size: 0.875rem; color: var(--text-muted); margin-bottom: 0.5rem;">Sequence</p>
                <p style="font-size: 1.875rem; font-weight: bold; color: var(--primary-light);" id="sequence">1</p>
            </div>
            <div style="text-align: center;">
                <p style="font-size: 0.875rem; color: var(--text-muted); margin-bottom: 0.5rem;">Score</p>
                <p style="font-size: 1.875rem; font-weight: bold; color: var(--success);" id="score">0</p>
            </div>
        </div>

        <!-- Game Board -->
        <div id="gameBoard" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.75rem; margin-bottom: 2rem; max-width: 300px; margin-left: auto; margin-right: auto; position: relative;">
        </div>

        <!-- Learning Tip -->
        <div id="learningTip" style="display: none; background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 0.5rem; padding: 1rem; margin-bottom: 2rem; text-align: center;">
            <p style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 0.5rem;">üí° Tip: Watch the numbers show the correct sequence order!</p>
            <p style="color: var(--text-muted); font-size: 0.75rem;">The numbers disappear when you start playing</p>
        </div>

        <!-- Controls -->
        <div style="display: flex; gap: 0.75rem; justify-content: center; margin-bottom: 2rem;">
            <button id="startBtn" onclick="startGame()" style="padding: 0.875rem 2rem; border-radius: 0.75rem; font-weight: 600; font-size: 1rem; border: none; cursor: pointer; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; box-shadow: 0 4px 16px rgba(99, 102, 241, 0.3); transition: all 250ms;">
                Start Game
            </button>
            <button id="resetBtn" onclick="resetGame()" style="padding: 0.875rem 2rem; border-radius: 0.75rem; font-weight: 600; font-size: 1rem; border: 1px solid var(--glass-border); cursor: pointer; background: var(--glass-bg); color: var(--text-primary); transition: all 250ms;">
                Reset
            </button>
        </div>

        <!-- Message -->
        <div id="message" style="text-align: center; font-size: 1.125rem; font-weight: 600; min-height: 1.5rem;"></div>
    </div>
</div>

<script>
    let sequence = [];
    let userSequence = [];
    let level = 1;
    let isPlaying = false;
    let gameActive = false;
    let showingSequence = false;

    // Initialize game board
    function initBoard() {
        const board = document.getElementById('gameBoard');
        board.innerHTML = '';
        for (let i = 0; i < 16; i++) {
            const button = document.createElement('button');
            button.style.width = '64px';
            button.style.height = '64px';
            button.style.background = 'linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%)';
            button.style.borderRadius = '0.5rem';
            button.style.border = 'none';
            button.style.cursor = 'pointer';
            button.style.transition = 'all 150ms';
            button.style.position = 'relative';
            button.dataset.index = i;
            button.addEventListener('click', handleButtonClick);
            button.addEventListener('mouseover', function() {
                if (gameActive && !showingSequence) {
                    this.style.transform = 'scale(1.05)';
                    this.style.boxShadow = '0 4px 12px rgba(99, 102, 241, 0.4)';
                }
            });
            button.addEventListener('mouseout', function() {
                this.style.transform = 'scale(1)';
                this.style.boxShadow = 'none';
            });
            board.appendChild(button);
        }
    }

    function handleButtonClick(e) {
        if (isPlaying || !gameActive || showingSequence) return;
        
        const index = parseInt(e.target.dataset.index);
        userSequence.push(index);
        flashButton(index);
        
        if (userSequence[userSequence.length - 1] !== sequence[userSequence.length - 1]) {
            const finalScore = sequence.length - 1;
            document.getElementById('message').textContent = `‚ùå Wrong! You reached Level ${level}. Score: ${finalScore}`;
            document.getElementById('message').style.color = 'var(--danger)';
            gameActive = false;
            disableStartButton(false);
            showCorrectSequence(); // Show the correct sequence after mistake
            saveScore();
            return;
        }
        
        if (userSequence.length === sequence.length) {
            level++;
            document.getElementById('message').textContent = '‚úÖ Correct! Next level...';
            document.getElementById('message').style.color = 'var(--success)';
            setTimeout(playNextLevel, 1500);
        }
    }

    function startGame() {
        console.log('Start game clicked');
        sequence = [];
        userSequence = [];
        level = 1;
        gameActive = true;
        disableStartButton(true);
        document.getElementById('message').textContent = '';
        document.getElementById('learningTip').style.display = 'block';
        updateDisplay();
        playNextLevel();
    }

    function resetGame() {
        sequence = [];
        userSequence = [];
        level = 1;
        isPlaying = false;
        gameActive = false;
        showingSequence = false;
        disableStartButton(false);
        updateDisplay();
        document.getElementById('message').textContent = '';
        document.getElementById('learningTip').style.display = 'none';
        clearSequenceNumbers();
    }

    function disableStartButton(disabled) {
        const startBtn = document.getElementById('startBtn');
        startBtn.disabled = disabled;
        startBtn.style.opacity = disabled ? '0.5' : '1';
        startBtn.style.cursor = disabled ? 'not-allowed' : 'pointer';
    }

    function updateDisplay() {
        document.getElementById('level').textContent = level;
        document.getElementById('sequence').textContent = sequence.length;
        document.getElementById('score').textContent = sequence.length - 1;
    }

    function playNextLevel() {
        userSequence = [];
        const index = Math.floor(Math.random() * 16);
        sequence.push(index);
        updateDisplay();
        
        setTimeout(() => {
            playSequence();
        }, 500);
    }

    function playSequence() {
        isPlaying = true;
        showingSequence = true;
        let delay = 600;
        
        sequence.forEach((index, i) => {
            setTimeout(() => {
                flashButton(index);
            }, delay + i * 600);
        });
        
        setTimeout(() => {
            isPlaying = false;
            showingSequence = false;
            showSequenceNumbers();
        }, delay + (sequence.length - 1) * 600 + 400);
    }

    function flashButton(index) {
        const buttons = document.querySelectorAll('#gameBoard button');
        const btn = buttons[index];
        btn.style.opacity = '0.3';
        btn.style.transform = 'scale(0.95)';
        
        setTimeout(() => {
            btn.style.opacity = '1';
            btn.style.transform = 'scale(1)';
        }, 300);
    }

    function showSequenceNumbers() {
        const buttons = document.querySelectorAll('#gameBoard button');
        sequence.forEach((index, order) => {
            const btn = buttons[index];
            const numberBadge = document.createElement('div');
            numberBadge.textContent = order + 1;
            numberBadge.style.position = 'absolute';
            numberBadge.style.top = '50%';
            numberBadge.style.left = '50%';
            numberBadge.style.transform = 'translate(-50%, -50%)';
            numberBadge.style.width = '28px';
            numberBadge.style.height = '28px';
            numberBadge.style.background = 'linear-gradient(135deg, var(--secondary) 0%, #ec4899 100%)';
            numberBadge.style.color = 'white';
            numberBadge.style.borderRadius = '50%';
            numberBadge.style.display = 'flex';
            numberBadge.style.alignItems = 'center';
            numberBadge.style.justifyContent = 'center';
            numberBadge.style.fontWeight = 'bold';
            numberBadge.style.fontSize = '0.875rem';
            numberBadge.style.zIndex = '10';
            numberBadge.className = 'sequence-number';
            btn.appendChild(numberBadge);
        });
    }

    function showCorrectSequence() {
        // Show the correct sequence one more time when user makes a mistake
        setTimeout(() => {
            const buttons = document.querySelectorAll('#gameBoard button');
            let delay = 300;
            
            sequence.forEach((index, i) => {
                setTimeout(() => {
                    const btn = buttons[index];
                    btn.style.opacity = '0.3';
                    btn.style.transform = 'scale(0.95)';
                    
                    setTimeout(() => {
                        btn.style.opacity = '1';
                        btn.style.transform = 'scale(1)';
                    }, 300);
                }, delay + i * 600);
            });
        }, 500);
    }

    function clearSequenceNumbers() {
        document.querySelectorAll('.sequence-number').forEach(badge => {
            badge.remove();
        });
    }

    function saveScore() {
        const finalScore = sequence.length - 1;
        fetch('/api/save-score', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                game_type: 'memory',
                score: finalScore,
                difficulty: 'medium'
            })
        })
        .then(r => r.json())
        .then(data => {
            console.log('Score saved:', data);
            setTimeout(() => location.reload(), 1000);
        });
    }

    // Initialize on load
    initBoard();
    disableStartButton(false);
</script>
{% endblock %}