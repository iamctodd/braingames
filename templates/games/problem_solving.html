{% extends "base.html" %}
{% block title %}Problem Solving{% endblock %}
{% block content %}
<div class="max-w-2xl mx-auto">
    <!-- Back Button -->
    <a href="/" class="inline-block mb-6 text-primary hover:text-primary-light font-semibold transition-colors">‚Üê Back to Home</a>

    <!-- Game Container -->
    <div class="glass-card animate-in">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2rem;">
            <div>
                <h1 style="font-size: 2.25rem; font-weight: bold; margin-bottom: 0.5rem;">üí° Problem Solving</h1>
                <p style="color: var(--text-secondary);">Read and solve real-world case studies</p>
            </div>
            <div style="text-align: right;">
                <p style="font-size: 0.875rem; color: var(--text-muted); margin-bottom: 0.25rem;">Problems Solved</p>
                <p style="font-size: 1.875rem; font-weight: bold; color: var(--success);" id="problemsCount">0</p>
            </div>
        </div>

        <!-- Progress Bar -->
        <div style="background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 0.5rem; padding: 1rem; margin-bottom: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                <p style="font-size: 0.875rem; font-weight: 600; color: var(--text-primary);">Progress</p>
                <p style="font-size: 0.875rem; color: var(--text-secondary);" id="progressText">Problem 1 of 5</p>
            </div>
            <div style="width: 100%; height: 8px; background: var(--glass-border); border-radius: 4px; overflow: hidden;">
                <div id="progressBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%); transition: width 250ms;"></div>
            </div>
        </div>

        <!-- Game Content Container -->
        <div id="gameContent">
            <!-- Case Study -->
            <div style="background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 2rem;">
                <h2 style="font-size: 1.25rem; font-weight: bold; margin-bottom: 1rem;" id="caseTitle">Loading case study...</h2>
                <p style="color: var(--text-secondary); margin-bottom: 1rem;" id="caseDescription"></p>
                <ul id="casePoints" style="list-style: disc; margin-left: 1.5rem; color: var(--text-secondary); space-y: 0.5rem;"></ul>
                <p style="font-weight: 600; color: var(--text-primary); margin-top: 1rem;">What would you suggest to solve this problem?</p>
            </div>

            <!-- Solution Input -->
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.75rem; color: var(--text-primary);">Your Solution</label>
                <textarea id="solution" rows="6" placeholder="Share your thoughts on how to solve this problem... (minimum 25 characters)" 
                          style="width: 100%; padding: 0.75rem; background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 0.5rem; color: var(--text-primary); font-family: inherit; resize: none; transition: all 250ms;" 
                          onfocus="this.style.borderColor = 'var(--primary)'; this.style.boxShadow = '0 0 0 3px rgba(99, 102, 241, 0.1)'"
                          onblur="this.style.borderColor = 'var(--glass-border)'; this.style.boxShadow = 'none'"
                          oninput="updateCharCount(); validateSubmit()"></textarea>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem;">
                    <p style="font-size: 0.75rem; color: var(--text-muted);">Character count: <span id="charCount">0</span>/25 (minimum)</p>
                </div>
            </div>

            <!-- Controls -->
            <div style="display: flex; gap: 0.75rem; margin-bottom: 2rem;">
                <button id="submitBtn" onclick="submitSolution()" disabled
                        style="flex: 1; padding: 0.875rem 2rem; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; border: none; border-radius: 0.75rem; font-weight: 600; cursor: not-allowed; transition: all 250ms; opacity: 0.5;">
                    Submit Solution
                </button>
                <button id="nextBtn" onclick="nextProblem()" disabled
                        style="padding: 0.875rem 2rem; background: var(--glass-bg); border: 1px solid var(--glass-border); color: var(--text-primary); border-radius: 0.75rem; font-weight: 600; cursor: not-allowed; transition: all 250ms; opacity: 0.5;">
                    Next Problem
                </button>
                <button onclick="document.getElementById('solution').value = ''; updateCharCount(); validateSubmit();" 
                        style="padding: 0.875rem 2rem; background: var(--glass-bg); border: 1px solid var(--glass-border); color: var(--text-primary); border-radius: 0.75rem; font-weight: 600; cursor: pointer; transition: all 250ms;">
                    Clear
                </button>
            </div>

            <!-- Feedback -->
            <div id="feedback" style="display: none; margin-bottom: 1.5rem;"></div>
        </div>

        <!-- Game Complete Screen -->
        <div id="completeScreen" style="display: none; text-align: center; padding: 2rem;">
            <p style="font-size: 3rem; margin-bottom: 1rem;">üéâ</p>
            <h2 style="font-size: 2rem; font-weight: bold; margin-bottom: 1rem; color: var(--success);">Great Job!</h2>
            <p style="font-size: 1.125rem; color: var(--text-secondary); margin-bottom: 2rem;">You completed all 5 case studies</p>
            
            <div style="background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 2rem;">
                <p style="font-size: 0.875rem; color: var(--text-muted); margin-bottom: 0.5rem;">Final Score</p>
                <p style="font-size: 2.25rem; font-weight: bold; color: var(--success);" id="finalScore">0</p>
                <p style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 1rem;">Average: <span id="avgScore">0</span>/100</p>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: center;">
                <a href="/" class="btn btn-primary" style="text-decoration: none; padding: 0.875rem 2rem; border-radius: 0.75rem;">
                    Back to Home
                </a>
                <a href="/dashboard" class="btn btn-secondary" style="text-decoration: none; padding: 0.875rem 2rem; border-radius: 0.75rem; background: var(--glass-bg); border: 1px solid var(--glass-border); color: var(--text-primary);">
                    View Dashboard
                </a>
            </div>
        </div>

        <!-- Score -->
        <div id="scoreSection" style="text-align: center; padding-top: 1.5rem; border-top: 1px solid var(--glass-border);">
            <p style="font-size: 0.875rem; color: var(--text-muted); margin-bottom: 0.5rem;">Session Score</p>
            <p style="font-size: 1.875rem; font-weight: bold; color: var(--success);" id="score">0</p>
        </div>
    </div>
</div>

<script>
    const casestudies = [
        {
            title: "Case Study 1: Coffee Shop Inventory Problem",
            description: "Sarah runs a small coffee shop. Every morning she makes 50 cups of coffee, but:",
            points: [
                "By noon, she often runs out and disappointed customers leave",
                "At closing time, she throws away 10-15 unsold cups",
                "She wastes money on wasted coffee",
                "She loses customers who come back and find none available"
            ]
        },
        {
            title: "Case Study 2: Team Communication Breakdown",
            description: "A software development team is struggling with project delays. The issues include:",
            points: [
                "Team members are not communicating progress effectively",
                "Tasks are duplicated because people don't know who's working on what",
                "Meetings are frequent but lack clear agendas",
                "Important decisions are being made without full team input"
            ]
        },
        {
            title: "Case Study 3: Customer Service Quality",
            description: "An online retailer is receiving poor customer satisfaction reviews. The problems are:",
            points: [
                "Response time to customer inquiries is slow (24-48 hours)",
                "Return process is complicated and frustrating",
                "No tracking information is provided during shipping",
                "Customer service representatives are not empowered to solve problems"
            ]
        },
        {
            title: "Case Study 4: Employee Turnover",
            description: "A tech startup is experiencing high employee turnover. Contributing factors include:",
            points: [
                "Lack of clear career growth paths for employees",
                "Compensation is below industry standards",
                "Work-life balance is poor with frequent overtime",
                "Company culture feels impersonal and not inclusive"
            ]
        },
        {
            title: "Case Study 5: Product Quality Issues",
            description: "A manufacturing company is facing increased defect rates. The situation is:",
            points: [
                "Quality control procedures have been rushed due to production deadlines",
                "Workers are not properly trained on new equipment",
                "There's no feedback loop to address emerging issues",
                "Management prioritizes speed over quality"
            ]
        }
    ];

    const MAX_PROBLEMS = 5;
    let currentCaseIndex = 0;
    let sessionScore = 0;
    let problemsSolved = 0;

    function loadCaseStudy(index) {
        const caseStudy = casestudies[index];
        document.getElementById('caseTitle').textContent = caseStudy.title;
        document.getElementById('caseDescription').textContent = caseStudy.description;
        
        const pointsList = document.getElementById('casePoints');
        pointsList.innerHTML = caseStudy.points.map(p => `<li style="margin-bottom: 0.5rem;">${p}</li>`).join('');
        
        document.getElementById('solution').value = '';
        document.getElementById('feedback').style.display = 'none';
        updateCharCount();
        validateSubmit();
        updateProgressBar();
    }

    function updateCharCount() {
        const count = document.getElementById('solution').value.length;
        document.getElementById('charCount').textContent = count;
    }

    function validateSubmit() {
        const solution = document.getElementById('solution').value;
        const submitBtn = document.getElementById('submitBtn');
        
        const isValid = solution.length >= 25;
        submitBtn.disabled = !isValid;
        submitBtn.style.opacity = isValid ? '1' : '0.5';
        submitBtn.style.cursor = isValid ? 'pointer' : 'not-allowed';
    }

    function updateProgressBar() {
        const progress = (currentCaseIndex + 1) / MAX_PROBLEMS * 100;
        document.getElementById('progressBar').style.width = progress + '%';
        document.getElementById('progressText').textContent = `Problem ${currentCaseIndex + 1} of ${MAX_PROBLEMS}`;
    }

    function nextProblem() {
        currentCaseIndex++;
        
        if (currentCaseIndex >= MAX_PROBLEMS) {
            showGameComplete();
            return;
        }
        
        loadCaseStudy(currentCaseIndex);
        document.getElementById('nextBtn').disabled = true;
        document.getElementById('nextBtn').style.opacity = '0.5';
        document.getElementById('nextBtn').style.cursor = 'not-allowed';
        document.getElementById('nextBtn').style.background = 'var(--glass-bg)';
    }

    function submitSolution() {
        const solution = document.getElementById('solution').value;
        
        if (solution.length < 25) {
            alert('Solution must be at least 25 characters');
            return;
        }

        let score = 0;
        score += Math.min(solution.length / 10, 100);
        
        const keywords = ['problem', 'solution', 'suggest', 'make', 'try', 'track', 'customer', 'waste', 'improve', 'process', 'team', 'communicate'];
        const solutionLower = solution.toLowerCase();
        keywords.forEach(keyword => {
            if (solutionLower.includes(keyword)) {
                score += 10;
            }
        });
        
        score = Math.min(Math.round(score), 100);
        sessionScore += score;
        problemsSolved++;

        const feedback = document.getElementById('feedback');
        feedback.innerHTML = `<div style="background: var(--glass-bg); border: 1px solid var(--success); border-radius: 0.5rem; padding: 1rem;"><p style="font-weight: 600; color: var(--success); margin-bottom: 0.5rem;">‚úÖ Solution submitted!</p><p style="font-size: 0.875rem; color: var(--text-secondary);">Score: ${score}/100</p></div>`;
        feedback.style.display = 'block';
        
        document.getElementById('problemsCount').textContent = problemsSolved;
        document.getElementById('score').textContent = sessionScore;

        // Disable submit, enable next
        document.getElementById('submitBtn').disabled = true;
        document.getElementById('submitBtn').style.opacity = '0.5';
        document.getElementById('submitBtn').style.cursor = 'not-allowed';
        
        document.getElementById('nextBtn').disabled = false;
        document.getElementById('nextBtn').style.opacity = '1';
        document.getElementById('nextBtn').style.cursor = 'pointer';
        document.getElementById('nextBtn').style.background = 'linear-gradient(135deg, var(--success) 0%, #059669 100%)';

        fetch('/api/save-score', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                game_type: 'problem_solving',
                score: score,
                difficulty: 'medium'
            })
        })
        .then(r => r.json())
        .then(data => {
            console.log('Score saved:', data);
        });
    }

    function showGameComplete() {
        document.getElementById('gameContent').style.display = 'none';
        document.getElementById('scoreSection').style.display = 'none';
        document.getElementById('completeScreen').style.display = 'block';
        
        document.getElementById('finalScore').textContent = sessionScore;
        const avgScore = Math.round(sessionScore / MAX_PROBLEMS);
        document.getElementById('avgScore').textContent = avgScore;
    }

    loadCaseStudy(0);
</script>
{% endblock %}